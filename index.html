<!DOCTYPE html>
<html>
<head>
    <title>Leaflet.heat demo</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <style>
        /*#map { width: 800px; height: 600px; }
        body { font: 16px/1.4 "Helvetica Neue", Arial, sans-serif; }
        .ghbtns { position: relative; top: 4px; margin-left: 5px; }
        a { color: #0077ff; }*/
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>

    <style>
    /*
     * Unlike other icons, you can style `L.divIcon` with CSS.
     * These styles make each marker a pink triangle.
     */
    .css-icon {
      width: 0;
      height: 0;
      border-top: 30px solid transparent;
      border-bottom: 30px solid transparent;
      border-left: 30px solid #ff8888;
      }
    </style>


</head>

<body>
<div id="map"></div>

<!-- <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script> -->
<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="http://zia-.github.io/firemap_data/geo_2015.js"></script>
<script>
// Fix mapbox token
L.mapbox.accessToken = 'pk.eyJ1IjoiemlhLW0iLCJhIjoiQjM5aVpfTSJ9.s_U7YxQCK-Zq5SaJemH5bA';
// 35.570652, 24.884267, 42.425880, 45.252919 Turkey bounds
// 40.903699, 28.697378  41.177273, 29.276363 Istanbul bounds which was used to download osm data
// Construct a bounding box for this map that the user cannot move out of
var minlatbound = 35.570652, minlonbound = 24.884267, maxlatbound = 42.425880, maxlonbound = 45.252919;
// var minlatbound = -6.983754, minlonbound = 38.982368, maxlatbound = -6.574648, maxlonbound = 39.500786;
var southWestbound = L.latLng(minlatbound, minlonbound),
    northEastbound = L.latLng(maxlatbound, maxlonbound),
    bounds = L.latLngBounds(southWestbound, northEastbound);

// Initialize the map
var map = L.mapbox.map('map', null, {
          maxBounds: bounds,
          maxZoom: 19,
          minZoom: 1
});
map.fitBounds(bounds);
// Code from here https://github.com/Leaflet/Leaflet.heat/blob/gh-pages/demo/index.html
// firedata = firedata.map(function (p) { return [p[2], p[3]]; });
// var heat = L.heatLayer(firedata);
// heat.addTo(map);

// Define an icon called cssIcon
// var cssIcon = L.divIcon({
//   // Specify a class name we can refer to in CSS.
//   className: 'css-icon',
//   // Set marker width and height
//   iconSize: [60, 60]
// });
//
// // Create three markers and set their icons to cssIcon
// L.marker([36, 32], {icon: cssIcon}).addTo(map);

// console.log(firedata.length);


// pointToLayer: function(feature, latlng) {
//         return L.circleMarker(latlng, {
//             radius: (feature.properties.population)/200000
//         })
//     },
//     style: function (feature) {
//     return {color: color_rgb_gen_redgreen( 78550, 14657434, feature.properties.population)};
//     	},
//     	onEachFeature: function (feature, layer) {
//     layer.bindPopup(feature.properties.population);
//     	}








var realurl = "https://raw.githubusercontent.com/Zia-/Zia-.github.io/master/firemap_data/SEVIRI_data.geojson";
var featureLayer = L.mapbox.featureLayer(realurl, {
    // pointToLayer: L.mapbox.marker.style,
    pointToLayer: function(feature, latlng) {
      // return L.circle([39.252220,-6.813335], 200)
    //   return L.polygon([[39.160210,-6.858332],[39.213768,-6.830380],[39.156776,-6.801745],[39.160210,-6.858332]], {color: 'red', opacity: 1, weight: 0})
        // return L.circleMarker(latlng, {
        //     radius: (feature.properties.previous_dominating_activity_confidence)/10
        //     // radius: 20
        //     // icon: L.polygon([[39.252220,-6.813335],[39.272220,-6.873335],[39.232220,-6.833335],[39.252220,-6.813335]], {color: 'red', opacity: 1, weight: 0})
        // })
        // console.log(latlng);
        var lng = latlng['lng']
        var lat = latlng['lat']
        // console.log(lon);
        // var lonmin = lon-0.02548
        return L.polygon([L.latLng(lat,lng-0.02548), L.latLng(lat+0.02548,lng), L.latLng(lat,lng+0.02548), L.latLng(lat-0.02548,lng), L.latLng(lat,lng-0.02548)]);
    },
    style: function (feature) {
      return {color: 'red', weight: 1, opacity: 1};
    },
    // popupOptions: function (feature) {
    //   var popup = L.popup()
    //               .setContent('<p>Hello world!<br />This is a nice popup.</p>')
    //   return {maxWidth: 100}
    // }
    // onEachFeature: function (feature, layer) {
    //   layer.bindPopup('aaa');
    //   // console.log("aaaasdasd");
  	// }
    // onEachFeature: onEachFeature
})
    // .loadURL('')
    // Once this layer loads, we set a timer to load it again in a few seconds.
    .on('ready', run)
    // .bindPopup('Hello world!')
    // .setStyle()
  //   .on('click', function(feature)
  //   {
  //     // console.log("aaa");
  //
  //       if (!feature.data) return;
  //       var popup = L.popup()
  //           .setLatLng(feature.latLng)
  //           .setContent(feature.properties.previous_dominating_activity_confidence)
  //           .openOn(map);
  //   }
  // )
    .addTo(map);

function run() {
    // map.featureLayer.eachLayer(function(marker) {
    //     // You can replace this test for anything else, to choose the right
    //     // marker on which to open a popup. by default, popups are exclusive
    //     // so opening a new one will close all of the others.
    //     // if (marker.feature.properties.title === 'Capital Pride Parade') {
    //     console.log("hhhh");
    //     // marker.openPopup();
    //     // }
    // });
    featureLayer.eachLayer(function(layer) {
      // console.log(layer.feature.properties.accuracy);

      var popup = new L.Popup({ autoPan: false });
      // popup.setContent('<div>' + layer.feature.properties.JDAY + '</div>' +
      //     layer.feature.properties.F_CONF + ' people per square mile');

      popup.setContent(
        // '<div class="container">'+
        '<div class="table-responsive">    '+
      '<table class = "table">'+
   '<caption><h1><strong>Fire Radiative Power:</strong> ' + Math.round(layer.feature.properties.FRP) + ' MW</h1></caption>'+
  //  '<thead>'+
  //     '<tr>'+
  //        '<th>Product</th>'+
  //        '<th>Payment Date</th>'+
  //       // ' <th>Status</th>'+
  //     '</tr>'+
  //  '</thead>'+
   '<tbody>'+
    '  <tr class = "danger">'+ // active success warning danger
      '   <td>Location</td>'+
        ' <td>Lon: ' + layer.feature.geometry.coordinates[0] + ', Lat: ' + layer.feature.geometry.coordinates[1] + '</td>'+
        // ' <td>Pending</td>'+
    '  </tr>'+
    '  <tr class = "warning">'+
      '   <td>Time</td>'+
      '   <td>' + layer.feature.properties.TIME + '</td>'+
      // '   <td>Delivered</td>'+
      '</tr>'+
      '<tr class = "success">'+
      '   <td>Pixel Size</td>'+
      '   <td>' + layer.feature.properties.PIXEL_SIZE + ' km<sup>2</sup></td>'+
      // '   <td>In Call to confirm</td>'+
    '  </tr>'+
    '  <tr class = "active">'+
    '     <td>Fire Confidence</td>'+
      '   <td>' + layer.feature.properties.F_CONF + '</td>'+
      // '   <td>Declined</td>'+
    '  </tr>'+
    '  <tr class = "active">'+
    '     <td>FIR Uncertainity</td>'+
      '   <td>' + layer.feature.properties.FRP_UNCER + '</td>'+
      // '   <td>Declined</td>'+
    '  </tr>'+
    '  </tr>'+
    '  <tr class = "active">'+
    '     <td>Brightness MIR Temp.</td>'+
      '   <td>' + layer.feature.properties.BT_MIR + ' K</td>'+
      // '   <td>Declined</td>'+
    '  </tr>'+
    '  </tr>'+
    '  <tr class = "active">'+
    '     <td>Brightness TIR Temp.</td>'+
      '   <td>' + layer.feature.properties.BT_TIR + ' K</td>'+
      // '   <td>Declined</td>'+
    '  </tr>'+
    // '  <tr class = "active">'+
    // '     <td>Brightness TIR Temp.</td>'+
    //   '   <td>' + layer.feature.properties.BW_BT_MIR + '</td>'+
    //   // '   <td>Declined</td>'+
    // '  </tr>'+
    '  <tr class = "active">'+
    '     <td>Julian Day</td>'+
      '   <td>' + layer.feature.properties.JDAY + '</td>'+
      // '   <td>Declined</td>'+
    '  </tr>'+
   '</tbody>'+
'</table>'+
// '  </div>'+
'</div>'
)















      layer.bindPopup(popup);
      // var str = layer.feature.properties.accuracy
      // layer.bindPopup(String(str));
        // map.panTo(l.getLatLng());
        // var popup = L.popup()
        //     .setLatLng(l.latLng)
        //     .setContent(l.color)
        //     .openOn(map);
    });
    window.setTimeout(function() {
        featureLayer.loadURL(realurl);
    }, 50000);
}






// function onEachFeature(feature, layer) {
//       layer.on({
//           mousemove: console.log("mousemove"),
//           mouseout: console.log("mouseout"),
//           click: console.log("click")
//       });
//   };






// for (i=0; i<firedata.length; ++i){
//   // console.log(firedata[i][2]);
//   // console.log(firedata[i][3]);
//   // xmin = firedata[i][2]-0.02548;
//   // xmax = firedata[i][2]+0.02548;
//   // ymin = firedata[i][3]-0.02548;
//   // ymax = firedata[i][3]+0.02548;
//   array = []
//   arr = [firedata[i][2]-0.02548, firedata[i][3]]
//   array.push(arr);
//   arr = [firedata[i][2], firedata[i][3]+0.02548]
//   array.push(arr);
//   arr = [firedata[i][2]+0.02548, firedata[i][3]]
//   array.push(arr);
//   arr = [firedata[i][2], firedata[i][3]-0.02548]
//   array.push(arr);
//   arr = [firedata[i][2]-0.02548, firedata[i][3]]
//   array.push(arr);
//   // 30, 40, 60, 80, 120 green,
//   rgb = '';
//   if (firedata[i][5] <= 30){rgb += '#0000FF'}
//   else if (firedata[i][5] > 30 && firedata[i][5] <= 40){rgb += '#00BFFF'}
//   else if (firedata[i][5] > 40 && firedata[i][5] <= 60){rgb += '#00FF80'}
//   else if (firedata[i][5] > 60 && firedata[i][5] <= 80){rgb += '#40FF00'}
//   else if (firedata[i][5] > 80 && firedata[i][5] <= 120){rgb += '#FFFF00'}
//   else if (firedata[i][5] > 120){rgb += '#FF4000'}
//   L.polygon(array, {color: rgb, opacity: 1, weight: 0}).addTo(map);
// }

// for (i = 0; i < 1000; ++i){
//   array = []
//   arr = [36+i/100, 32+i/100]
//   array.push(arr);
//   arr = [36.1+i/100, 32.1+i/100]
//   array.push(arr);
//   arr = [36.2+i/100, 32.2+i/100]
//   array.push(arr);
//   arr = [36+i/100, 32+i/100]
//   array.push(arr);
//   L.polygon(array, {color: 'red'}).addTo(map);
// };
// L.polygon([[36, 32],[37,32],[38,33],[36,32]], {color: 'red'}).addTo(map);

// Other mapbox layers https://www.mapbox.com/api-documentation/#maps
var layers = {
      Dark: L.mapbox.tileLayer('mapbox.dark'),
      Streets: L.mapbox.tileLayer('mapbox.streets'),
      Light: L.mapbox.tileLayer('mapbox.light'),
      Satellite: L.mapbox.tileLayer('mapbox.satellite'),
      StreetsSatellite: L.mapbox.tileLayer('mapbox.streets-satellite'),
      Wheatpaste: L.mapbox.tileLayer('mapbox.wheatpaste'),
      StreetsBasic: L.mapbox.tileLayer('mapbox.streets-basic'),
      Comic: L.mapbox.tileLayer('mapbox.comic'),
      Outdoors: L.mapbox.tileLayer('mapbox.outdoors'),
      RunBikeHike: L.mapbox.tileLayer('mapbox.run-bike-hike'),
      Pencil: L.mapbox.tileLayer('mapbox.pencil'),
      Pirates: L.mapbox.tileLayer('mapbox.pirates'),
      Emerald: L.mapbox.tileLayer('mapbox.emerald'),
      HighContrast: L.mapbox.tileLayer('mapbox.high-contrast')
};

layers.Dark.addTo(map);
L.control.layers(layers).addTo(map);
</script>
</body>
</html>
